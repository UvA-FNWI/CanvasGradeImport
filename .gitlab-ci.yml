stages:
  - sync

sync_with_github:
  stage: sync
  image: alpine:3.19

  # Serialize all syncs
  resource_group: github-mirror

  rules:
    # Only sync main
    - if: '$CI_COMMIT_BRANCH != "main"'
      when: never

    # Prevent mirror loops
    - if: '$CI_COMMIT_MESSAGE =~ /\[SYNC\]/'
      when: never

    # Auto-sync on push to main
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: on_success

    # Allow manual trigger
    - when: manual
      allow_failure: false

  script:
    - set -e

    # Install dependencies
    - apk add --no-cache git curl jq

    - git config user.name "GitLab CI Mirror"
    - git config user.email "noreply@gitlab-mirror.local"

    # Add GitHub remote (safe if already exists)
    - git remote add github https://$GITHUB_MIRROR_USER:$GITHUB_MIRROR_TOKEN@github.com/UvA-FNWI/CanvasGradeImport.git || true

    # Fetch both remotes
    - git fetch origin
    - git fetch github

    # Create/reset local main branch from GitLab
    - git checkout -B main origin/main

    # Merge GitHub main into GitLab main (allow unrelated histories on first merge) (fail loudly on conflict)
    - git merge github/main --no-edit || git merge github/main --allow-unrelated-histories --no-edit

    # Only commit if something actually changed
    - |
      # Only commit if there are real changes after the merge
      if [ -n "$(git status --porcelain)" ]; then
        git commit -am "[SYNC] GitLab <-> GitHub sync"
      else
        echo "No changes from GitHub to sync."
      fi

    # Push to a PR branch on GitHub instead of main
    - git push github main:mirror-sync -f

    # Check if a PR already exists from mirror-sync → main
    #- |
    #  PR_EXISTS=$(curl -s -H "Authorization: token $GITHUB_MIRROR_TOKEN" \
    #    "https://api.github.com/repos/UvA-FNWI/CanvasGradeImport/pulls?head=$GITHUB_MIRROR_USER:mirror-sync&base=main" | jq '.[0].number')
    #
    #  if [ "$PR_EXISTS" = "null" ]; then
    #    echo "Creating new PR..."
    #    curl -s -X POST -H "Authorization: token $GITHUB_MIRROR_TOKEN" \
    #      -d '{"title":"[SYNC] GitLab → GitHub","head":"mirror-sync","base":"main","body":"Automated mirror from GitLab"}' \
    #      https://api.github.com/repos/UvA-FNWI/CanvasGradeImport/pulls
    #  else
    #    echo "PR #$PR_EXISTS already exists; branch updated automatically."
    #  fi
