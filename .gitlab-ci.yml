stages:
  - sync

# -------------------------------
# JOB 1: GitLab -> GitHub (push to mirror PR branch)
# -------------------------------
sync_with_github:
  stage: sync
  image: alpine:3.19
  resource_group: github-mirror  # serialize all syncs

  rules:
    # Only run for main branch
    - if: '$CI_COMMIT_BRANCH != "main"'
      when: never
    # Prevent mirror loops
    - if: '$CI_COMMIT_MESSAGE =~ /\[SYNC\]/'
      when: never
    # Run on push
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: on_success
    # Allow manual trigger
    - when: manual
      allow_failure: false

  script:
    - set -e

    # Install dependencies
    - apk add --no-cache git curl

    # Configure CI identity
    - git config user.name "GitLab CI Mirror"
    - git config user.email "noreply@gitlab-mirror.local"

    # Add GitHub remote
    - git remote add github https://$GITHUB_MIRROR_USER:$GITHUB_MIRROR_TOKEN@github.com/UvA-FNWI/CanvasGradeImport.git || true

    # Fetch both remotes
    - git fetch origin
    - git fetch github

    # Checkout main branch from GitLab
    - git checkout -B main origin/main

    # Merge GitHub main into GitLab main (allow unrelated histories first time)
    - git merge github/main --allow-unrelated-histories --no-edit || true

    # Commit only if changes exist
    - |
      if [ -n "$(git status --porcelain)" ]; then
        git commit -am "[SYNC] GitLab ↔ GitHub sync"
      else
        echo "No changes from GitHub to sync."
      fi

    # Push to a dedicated PR branch on GitHub
    - git push github main:mirror-sync -f

    # Create PR automatically (fails silently if it exists)
    - |
      curl -s -X POST -H "Authorization: token $GITHUB_MIRROR_TOKEN" \
        -d '{"title":"[SYNC] GitLab → GitHub","head":"mirror-sync","base":"main","body":"Automated mirror from GitLab"}' \
        https://api.github.com/repos/UvA-FNWI/CanvasGradeImport/pulls || true

# -------------------------------
# JOB 2: GitHub -> GitLab (pull merged PRs)
# -------------------------------
pull_github_into_gitlab:
  stage: sync
  image: alpine:3.19
  resource_group: github-mirror  # serialize with the previous job

  rules:
    # Only run for main
    - if: '$CI_COMMIT_BRANCH != "main"'
      when: never
    # Prevent mirror loops
    - if: '$CI_COMMIT_MESSAGE =~ /\[SYNC\]/'
      when: never
    # Allow manual trigger
    - when: manual
      allow_failure: false

  script:
    - set -e

    # Install git
    - apk add --no-cache git

    # Configure CI identity
    - git config user.name "GitLab CI Mirror"
    - git config user.email "noreply@gitlab-mirror.local"

    # Add GitHub remote
    - git remote add github https://$GITHUB_MIRROR_USER:$GITHUB_MIRROR_TOKEN@github.com/UvA-FNWI/CanvasGradeImport.git || true

    # Fetch GitHub main
    - git fetch github main

    # Checkout local main
    - git checkout main

    # Merge GitHub main into GitLab main
    - git merge github/main --no-edit || true

    # Commit only if there are real changes
    - |
      if [ -n "$(git status --porcelain)" ]; then
        git commit -am "[SYNC] GitHub → GitLab sync"
      else
        echo "No changes from GitHub to sync."
      fi

    # Push merged changes back to GitLab main
    - git push origin main
