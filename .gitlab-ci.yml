stages:
  - sync

sync_with_github:
  stage: sync
  image: alpine:3.19

  # Serialize all syncs
  resource_group: github-mirror

  rules:
    # Only sync main
    - if: '$CI_COMMIT_BRANCH != "main"'
      when: never

    # Prevent mirror loops
    - if: '$CI_COMMIT_MESSAGE =~ /\[SYNC\]/'
      when: never

    # Auto-sync on push to main
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: on_success

    # Allow manual trigger
    - when: manual
      allow_failure: false

  script:
    - set -e
    - apk add --no-cache git

    - git config user.name "GitLab CI Mirror"
    - git config user.email "noreply@gitlab-mirror.local"

    # Add GitHub remote (safe if already exists)
    - git remote add github https://$GITHUB_MIRROR_USER:$GITHUB_MIRROR_TOKEN@github.com/UvA-FNWI/CanvasGradeImport.git || true

    # Fetch latest state
    - git fetch origin
    - git fetch github

    # Ensure correct branch
    - git checkout -B main origin/main

    # Merge GitHub â†’ GitLab (fail loudly on conflict)
    - git merge github/main --no-edit || git merge github/main --allow-unrelated-histories --no-edit

    # Only push if something actually changed
    - |
      # Only commit if there are real changes after the merge
      if [ -n "$(git status --porcelain)" ]; then
        git commit -am "[SYNC] GitLab <-> GitHub sync"
      else
        echo "No changes from GitHub to sync."
      fi

    # Push to GitHub
    - git push github main

